#include "DLLmain.h"
#include <string>

DWORD excludes[] = { '4@A ','5@A ','6@A ','7@A ','8@A ','9@A ','115 ','183 ','251 ','319 ','387 ','455 ','7@5 ','8@5 ','9@5 ','1@6 ','2@6 ','3@6 ','150 ','218 ','286 ','354 ','422 ','490 ','148 ','216 ','284 ','352 ','420 ','488 ','156 ','224 ','292 ','360 ','428 ','496 ','110 ','178 ','246 ','314 ','382 ','450 ','121 ','189 ','257 ','325 ','393 ','461 ','154 ','222 ','290 ','358 ','426 ','494 ','145 ','213 ','281 ','349 ','417 ','485 ','j25 ','j42 ','j59 ','j76 ','j93 ','o20 ','l12 ','l16 ','l20 ','l24 ','l28 ','l32 ','8@8 ','9@8 ','1@9 ','2@9 ','3@9 ','4@9 ','139 ','207 ','275 ','343 ','411 ','479 ','120 ','188 ','256 ','324 ','392 ','460 ','104 ','172 ','240 ','308 ','376 ','444 ','3@7 ','4@7 ','5@7 ','6@7 ','7@7 ','8@7 ','j23 ','j40 ','j57 ','j74 ','j91 ','o18 ','j13 ','j30 ','j47 ','j64 ','j81 ','j98 ','j24 ','j41 ','j58 ','j75 ','j92 ','o19 ','108 ','176 ','244 ','312 ','380 ','448 ','124 ','192 ','260 ','328 ','396 ','464 ','163 ','231 ','299 ','367 ','435 ','503 ','1@1 ','2@1 ','3@1 ','4@1 ','5@1 ','6@1 ','l53 ','l57 ','l61 ','l65 ','l69 ','l73 ','113 ','181 ','249 ','317 ','385 ','453 ','142 ','210 ','278 ','346 ','414 ','482 ','5@D ','6@D ','7@D ','8@D ','9@D ','1@E ','143 ','211 ','279 ','347 ','415 ','483 ','116 ','184 ','252 ','320 ','388 ','456 ','j14 ','j31 ','j48 ','j65 ','j82 ','j99 ','j10 ','j27 ','j44 ','j61 ','j78 ','j95 ','103 ','171 ','239 ','307 ','375 ','443 ','128 ','196 ','264 ','332 ','400 ','468 ','111 ','179 ','247 ','315 ','383 ','451 ','147 ','215 ','283 ','351 ','419 ','487 ','123 ','191 ','259 ','327 ','395 ','463 ','109 ','177 ','245 ','313 ','381 ','449 ','135 ','203 ','271 ','339 ','407 ','475 ','153 ','221 ','289 ','357 ','425 ','493 ','6@9 ','7@9 ','8@9 ','9@9 ','1@A ','2@A ','130 ','198 ','266 ','334 ','402 ','470 ','122 ','190 ','258 ','326 ','394 ','462 ','l36 ','l39 ','l42 ','l45 ','l48 ','l51 ','112 ','180 ','248 ','316 ','384 ','452 ','l13 ','l17 ','l21 ','l25 ','l29 ','l33 ','159 ','227 ','295 ','363 ','431 ','499 ','114 ','182 ','250 ','318 ','386 ','454 ','9@B ','1@C ','2@C ','3@C ','4@C ','5@C ','j22 ','j39 ','j56 ','j73 ','j90 ','o17 ','l54 ','l58 ','l62 ','l66 ','l70 ','l74 ','161 ','229 ','297 ','365 ','433 ','501 ','5@6 ','6@6 ','7@6 ','8@6 ','9@6 ','1@7 ','132 ','200 ','268 ','336 ','404 ','472 ','j20 ','j37 ','j54 ','j71 ','j88 ','o15 ','1@8 ','2@8 ','3@8 ','4@8 ','5@8 ','6@8 ','144 ','212 ','280 ','348 ','416 ','484 ','119 ','187 ','255 ','323 ','391 ','459 ','l52 ','l56 ','l60 ','l64 ','l68 ','l72 ','165 ','233 ','301 ','369 ','437 ','505 ','162 ','230 ','298 ','366 ','434 ','502 ','152 ','220 ','288 ','356 ','424 ','492 ','105 ','173 ','241 ','309 ','377 ','445 ','167 ','235 ','303 ','371 ','439 ','507 ','126 ','194 ','262 ','330 ','398 ','466 ','j19 ','j36 ','j53 ','j70 ','j87 ','o14 ','j18 ','j35 ','j52 ','j69 ','j86 ','o13 ','j17 ','x34 ','j51 ','j68 ','j85 ','o12 ','6@2 ','7@2 ','8@2 ','9@2 ','1@3 ','2@3 ','l35 ','l38 ','l41 ','l44 ','l47 ','l50 ','117 ','185 ','253 ','321 ','389 ','457 ','127 ','195 ','263 ','331 ','399 ','467 ','7@C ','8@C ','9@C ','1@D ','2@D ','3@D ','141 ','209 ','277 ','345 ','413 ','481 ','133 ','201 ','269 ','337 ','405 ','473 ','158 ','226 ','294 ','362 ','430 ','498 ','2@4 ','3@4 ','4@4 ','5@4 ','6@4 ','7@4 ','j16 ','j33 ','j50 ','j67 ','j84 ','o11 ','l55 ','l59 ','l63 ','l67 ','l71 ','l75 ','102 ','170 ','238 ','306 ','374 ','442 ','j11 ','j28 ','j45 ','j62 ','j79 ','j96 ','129 ','197 ','265 ','333 ','401 ','469 ','101 ','169 ','237 ','305 ','373 ','441 ','j26 ','j43 ','j60 ','j77 ','j94 ','o21 ','8@1 ','9@1 ','1@2 ','2@2 ','3@2 ','4@2 ','164 ','232 ','300 ','368 ','436 ','504 ','160 ','228 ','296 ','364 ','432 ','500 ','134 ','202 ','270 ','338 ','406 ','474 ','151 ','219 ','287 ','355 ','423 ','491 ','100 ','168 ','236 ','304 ','372 ','440 ','166 ','234 ','302 ','370 ','438 ','506 ','j12 ','j29 ','j46 ','j63 ','j80 ','j97 ','9@4 ','1@5 ','2@5 ','3@5 ','4@5 ','5@5 ','137 ','205 ','273 ','341 ','409 ','477 ','140 ','208 ','276 ','344 ','412 ','480 ','125 ','193 ','261 ','329 ','397 ','465 ','j15 ','j32 ','j49 ','j66 ','j83 ','o10 ','3@E ','4@E ','5@E ','6@E ','7@E ','8@E ','149 ','217 ','285 ','353 ','421 ','489 ','146 ','214 ','282 ','350 ','418 ','486 ','136 ','204 ','272 ','340 ','408 ','476 ','1@F ','2@F ','3@F ','4@F ','5@F ','6@F ','138 ','206 ','274 ','342 ','410 ','478 ','107 ','175 ','243 ','311 ','379 ','447 ','4@3 ','5@3 ','6@3 ','7@3 ','8@3 ','9@3 ','157 ','225 ','293 ','361 ','429 ','497 ','l10 ','l14 ','l18 ','l22 ','l26 ','l30 ','118 ','186 ','254 ','322 ','390 ','458 ','l34 ','l37 ','l40 ','l43 ','l46 ','l49 ','131 ','199 ','267 ','335 ','403 ','471 ','155 ','223 ','291 ','359 ','427 ','495 ','106 ','174 ','242 ','310 ','378 ','446 ','j21 ','j38 ','j55 ','j72 ','j89 ','o16 ','l11 ','l15 ','l19 ','l23 ','l27 ','l31 ','!01 ','!02 ','!03 ','!04 ','!05 ','!06 ','!08 ','!09 ','!10 ','!11 ','!12 ','!13 ','!15 ','!16 ','!17 ','!18 ','!19 ','!20 ','!22 ','!23 ','!24 ','!25 ','!26 ','!27 ','19@ ','!29 ','!30 ','!31 ','!32 ','!33 ','!35 ','!36 ','!37 ','!38 ','!39 ','!40 ','!42 ','!43 ','!44 ','!45 ','!46 ','!47 ','!49 ','!50 ','!51 ','!52 ','!53 ','!54 ','!56 ','!57 ','!58 ','!59 ','!60 ','!61 ','!63 ','!64 ','!65 ','!66 ','!67 ','!68 ','!70 ','!71 ','!72 ','!73 ','!74 ','!75 ','!77 ','!78 ','!79 ','!80 ','!81 ','!82 ','!84 ','!85 ','!86 ','!87 ','!88 ','!89 ','!91 ','!92 ','!93 ','!94 ','!95 ','!96 ','!98 ','!99 ','!1! ','!2! ','!3! ','!4! ','w23 ','w43 ','w63 ','w83 ','e13 ','e33 ','614 ','660 ','706 ','752 ','798 ','844 ','w12 ','w32 ','w52 ','w72 ','w92 ','e22 ','8@N ','9@N ','1@O ','2@O ','3@O ','4@O ','w18 ','w38 ','w58 ','w78 ','w98 ','e28 ','01! ','02! ','03! ','04! ','05! ','06! ','w19 ','w39 ','w59 ','w79 ','w99 ','e29 ','4@I ','5@I ','6@I ','7@I ','8@I ','9@I ','629 ','675 ','721 ','767 ','813 ','859 ','50! ','51! ','52! ','53! ','54! ','55! ','4@P ','5@P ','6@P ','7@P ','8@P ','9@P ','645 ','691 ','737 ','783 ','829 ','875 ','642 ','688 ','734 ','780 ','826 ','872 ','637 ','683 ','729 ','775 ','821 ','867 ','607 ','653 ','699 ','745 ','791 ','837 ','29! ','30! ','31! ','32! ','33! ','34! ','621 ','667 ','713 ','759 ','805 ','851 ','22! ','23! ','24! ','25! ','26! ','27! ','615 ','661 ','707 ','753 ','799 ','845 ','2@J ','3@J ','4@J ','5@J ','6@J ','7@J ','7@K ','8@K ','9@K ','1@L ','2@L ','3@L ','639 ','685 ','731 ','777 ','823 ','869 ','634 ','680 ','726 ','772 ','818 ','864 ','606 ','652 ','698 ','744 ','790 ','836 ','k01 ','k05 ','k09 ','k13 ','k17 ','k21 ','k02 ','k06 ','k10 ','k14 ','k18 ','k22 ','620 ','666 ','712 ','758 ','804 ','850 ','w24 ','w44 ','w64 ','w84 ','e14 ','e34 ','w29 ','w49 ','w69 ','w89 ','e19 ','e39 ','k04 ','k08 ','k12 ','k16 ','k20 ','k24 ','5@L ','6@L ','7@L ','8@L ','9@L ','1@M ','w13 ','w33 ','w53 ','w73 ','w93 ','e23 ','w16 ','w36 ','w56 ','w76 ','w96 ','e26 ','610 ','656 ','702 ','748 ','794 ','840 ','618 ','664 ','710 ','756 ','802 ','848 ','613 ','659 ','705 ','751 ','797 ','843 ','1@G ','2@G ','3@G ','4@G ','5@G ','6@G ','w28 ','w48 ','w68 ','w88 ','e18 ','e38 ','636 ','682 ','728 ','774 ','820 ','866 ','36! ','37! ','38! ','39! ','40! ','41! ','612 ','658 ','704 ','750 ','796 ','842 ','626 ','672 ','718 ','764 ','810 ','856 ','619 ','665 ','711 ','757 ','803 ','849 ','641 ','687 ','733 ','779 ','825 ','871 ','602 ','648 ','694 ','740 ','786 ','832 ','w11 ','w31 ','w51 ','w71 ','w91 ','e21 ','630 ','676 ','722 ','768 ','814 ','860 ','638 ','684 ','730 ','776 ','822 ','868 ','633 ','679 ','725 ','771 ','817 ','863 ','617 ','663 ','709 ','755 ','801 ','847 ','w22 ','w42 ','w62 ','w82 ','e12 ','e32 ','w17 ','w37 ','w57 ','w77 ','w97 ','e27 ','43! ','44! ','45! ','46! ','47! ','48! ','w15 ','w35 ','w55 ','w75 ','w95 ','e25 ','6@H ','7@H ','8@H ','9@H ','1@I ','2@I ','624 ','670 ','716 ','762 ','808 ','854 ','8@G ','9@G ','1@H ','2@H ','3@H ','4@H ','623 ','669 ','715 ','761 ','807 ','853 ','601 ','647 ','693 ','739 ','785 ','831 ','632 ','678 ','724 ','770 ','816 ','862 ','628 ','674 ','720 ','766 ','812 ','858 ','635 ','681 ','727 ','773 ','819 ','865 ','611 ','657 ','703 ','749 ','795 ','841 ','640 ','686 ','732 ','778 ','824 ','870 ','644 ','690 ','736 ','782 ','828 ','874 ','9@J ','1@K ','2@K ','3@K ','4@K ','5@K ','1@N ','2@N ','3@N ','4@N ','5@N ','6@N ','08! ','09! ','10! ','11! ','12! ','13! ','609 ','655 ','701 ','747 ','793 ','839 ','631 ','677 ','723 ','769 ','815 ','861 ','w25 ','w45 ','w65 ','w85 ','e15 ','e35 ','600 ','646 ','692 ','738 ','784 ','830 ','604 ','650 ','696 ','742 ','788 ','834 ','w21 ','w41 ','w61 ','w81 ','e11 ','e31 ','627 ','673 ','719 ','765 ','811 ','857 ','605 ','651 ','697 ','743 ','789 ','835 ','15! ','16! ','17! ','18! ','19! ','20! ','616 ','662 ','708 ','754 ','800 ','846 ','622 ','668 ','714 ','760 ','806 ','852 ','3@M ','4@M ','5@M ','6@M ','7@M ','8@M ','643 ','689 ','735 ','781 ','827 ','873 ','w14 ','w34 ','w54 ','w74 ','w94 ','e24 ','608 ','654 ','700 ','746 ','792 ','838 ','603 ','649 ','695 ','741 ','787 ','833 ','w20 ','w40 ','w60 ','w80 ','e10 ','e30 ','k03 ','k07 ','k11 ','k15 ','k19 ','k23 ','6@O ','7@O ','8@O ','9@O ','1@P ','2@P ','625 ','671 ','717 ','763 ','809 ','855 ','w27 ','w47 ','w67 ','w87 ','e17 ','e37 ','w10 ','w30 ','w50 ','w70 ','w90 ','e20 ','w26 ','w46 ','w66 ','w86 ','e16 ','e36 ','gcv ','gfv ','gsv ','gcy ','gfy ','gsy ','gcb ','gfb ','gsb ','gcg ','gfg ','gsg ','gcr ','gfr ','gsr ','gcw ','gfw ','gsw ','hp1 ','hp2 ','hp3 ','hp4 ','hp5 ','mp1 ','mp2 ','mp3 ','mp4 ','mp5 ','skc ','skf ','sku ','r01 ','r02 ','r03 ','r04 ','r05 ','r06 ','r07 ','r08 ','r09 ','r10 ','r11 ','r12 ','r13 ','r14 ','r15 ','r16 ','r17 ','yo1 ','yo2 ','yo3 ','&01 ','&02 ','&03 ','&04 ','&45 ','&11 ','&17 ','&18 ','&19 ','&20 ','&05 ','&06 ','&07 ','&08 ','&09 ','&10 ','&12 ','&13 ','&14 ','&15 ','&16 ','&41 ','&42 ','&43 ','&44 ','&21 ','&22 ','&23 ','&24 ','&25 ','&26 ','&27 ','&28 ','&29 ','&30 ','&46 ','&47 ','&48 ','&49 ','&50 ','&51 ','&52 ','&53 ','&54 ','&55 ','&31 ','&32 ','&33 ','&34 ','&35 ','&36 ','&37 ','&38 ','&39 ','&40 ','&56 ','&57 ','&58 ','&59 ','&60 ','&61 ','&62 ','&63 ','&64 ','&65 ','01+ ','02+ ','03+ ','04+ ','45+ ','11+ ','17+ ','18+ ','19+ ','20+ ','05+ ','06+ ','07+ ','08+ ','09+ ','10+ ','12+ ','13+ ','14+ ','15+ ','16+ ','41+ ','42+ ','43+ ','44+ ','21+ ','22+ ','23+ ','24+ ','25+ ','26+ ','27+ ','28+ ','29+ ','30+ ','46+ ','47+ ','48+ ','49+ ','50+ ','51+ ','52+ ','53+ ','54+ ','55+ ','31+ ','32+ ','33+ ','34+ ','35+ ','36+ ','37+ ','38+ ','39+ ','40+ ','56+ ','57+ ','58+ ','59+ ','60+ ','61+ ','62+ ','63+ ','64+ ','65+ ','z1+ ','z2+ ','z3+ ','z4+ ','z5+ ','&a1 ','&a2 ','&a3 ','&a4 ','&a5 ','g$a ','g$b ','g$c ','9$a ','9$b ','9$c ','7$a ','7$b ','7$c ','5$a ','5$b ','5$c ' };

BOOL __fastcall DROPFILTER_Main(D2UnitStrc* pItem)
{
	if (pItem->pItemData == NULL)
		return FALSE;

	if (GetAsyncKeyState(VK_CONTROL) & 0x8000)
		return TRUE;

	// Socketed
	if (pItem->pInventory != NULL && pItem->pInventory->dwItemCount > 0)
		return TRUE;

	DWORD dwQuality = pItem->pItemData->dwQuality;
	// UNIQUE, SET, CRAFTED, HONORIFIC
	if (dwQuality == 7 || dwQuality == 5 || dwQuality == 8 || dwQuality == 9)
		return TRUE;

	D2ItemsTXT* pItemTxt = D2COMMON_GetItemTxtRecord(pItem->dwClass);
	if (pItemTxt == NULL){ return FALSE; }

	DWORD dwCode = CODE32(pItemTxt->dwCode);

	if (dwCode == 'jew ')
		return TRUE; // Jewels
	else if (dwCode == 'tsc ' || dwCode == 'isc ' || dwCode == 'key ' || dwCode == 'tbk ' || dwCode == 'ibk ')
		return FALSE; // TP scrolls, ID scrolls, keys, TP tomes, ID tomes
	else if (dwCode == 'gld ' && pItem->pStatsEx != NULL && pItem->pStatsEx->BaseStats.pStat != NULL && pItem->pStatsEx->BaseStats.pStat->dwStatValue < 5000)
		return FALSE; // Gold stacks below 5,000
	else if (dwQuality == 4 && (dwCode == 'rin ' || dwCode == 'amu '))
		return FALSE; // Magic rings and amulets
	else if (dwQuality < 4 && (dwCode == 'aqv ' || dwCode == 'cqv '))
		return FALSE; // White quivers

	int j = sizeof(excludes) / sizeof(excludes[0]);
	for (int i = 0; i < j; ++i)
		if (dwCode == excludes[i])
			return FALSE;

	return TRUE;
}